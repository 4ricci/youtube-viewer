#!/usr/bin/perl -w
#
# Copyright (C) 2010-2011 Trizen <echo dHJpemVueEBnbWFpbC5jb20K | base64 -d>.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

=start
-------------------------------------------------------
  (C) 2010-2011 by Trizen
  Created on: 02 Jun 2010
  Last edit on: 23 March 2011
  Website: http://trizen.go.ro
  Email: echo dHJpemVueEBnbWFpbC5jb20K | base64 -d
-------------------------------------------------------

[?] What is this script for?          
 - This script is useful if do you hate the Flash Player and love YouTube.
 - Using this script you can search and play YouTube Videos with MPlayer...
 - Have fun!

[!] Most important changes are written in the changelog!

 [CHANGELOG]
 - Re-added the support for the next page / Added support for download (-d, --download)       - NEW (v2.4.*)
 - Added support for youtube subtitles. (Depends on: 'gcap' - http://code.google.com/p/gcap/) - NEW (v2.4.*)
 - First version with Windows support. Require SMPlayer to play videos. See MPlayer Line      - NEW (v2.4.*)
 - Code has been changed in a proportion of ~60% and optimized for speed // --480 became -4   - NEW (v2.4.*)
 - Added mega-powers of omnibox to the STDIN :)                                               - NEW (v2.3.*)
 - Re-added the option to list and play youtube videos from a user profile. Usage: -u [user]  - NEW (v2.3.*)
 - Added a new option to play all video clips from a category. Usage: '-c 9' and insert 'all' - NEW (v2.3.*)
 - Category area is more friendly... New options: -c [n] where 'n' is the number of category  - NEW (v2.3.*)
 - Added a new option to play only the audio track of a videoclip. Usage: [words] -n          - NEW (v2.3.*)
 - Added option for fullscreen (-f, --fullscreen). Usage: youtube-viewer [words] -f           - NEW (v2.3.*)
 - Added one new option '-c'. It shows available categories and will let you to choose one.   - NEW (v2.3.*)
 - Added one new option '-m'. It shows 3 pages of youtube video results. Usage: [words] -m    - NEW (v2.3.*)
 - For "-p" option has been added 3 pages of youtube video results (60 clips)                 - NEW (v2.3.*)
 - Added "-prefer-ipv4" to the mplayer line (videoclips starts in no time now).               - NEW (v2.3.*)
 - Search and play videos at 480p, 720p. Ex: [words] --480, [words] -p --480                  - NEW (v2.3.*)
 - Search has been corrected due to some YouTube changes...                                   - (v2.2.*)
 - Added support to play a video at 480p even if it's resolution is higher. Ex: [url] --480   - (v2.2.*)
 - Added a nice feature which prints some informations about the video which you watching at  - (v2.2.*)
 - Added support to play videos by your order. Example: after search results, insert: 3 5 2 1 - (v2.1.*)
 - Added support for next pages of video results (press ENTER when ask you to insert number)  - (v2.1.*)
 - Bug fixed: "Numbers go crazy after more than 20 video results".                            - (v2.1.*)
 - Added support to continue playing searched videos, usage: "youtube-viewer [words] -p"      - (v2.1.*)
 - Added support to print counted videos and support to insert the number of video to play it - (v2.1.*)
 - Added support to search YouTube Videos in script (ex: youtube-viewer avatar trailer 2009)  - (v2.0.*)
 - Added support for script to choose automat quality if it is lower than 1080p               - (v2.0.*)
 - Added support to choose the quality only between 720p and 1080p (if it is available)       - (v2.0.*)
 - Added support for an YouTube video code (ex: youtube-viewer WVTWCPoUt8w)                   - (v1.0.*)
 - Added support for 720p and 1080p YouTube Videos...                                         - (v1.0.*)
 
 Special thanks to:
 - Army (for bugs reports and for his great ideas)
 - dhn (for adding youtube-viewer in freshports.org)
=cut

use URI::Escape;
use HTML::Entities;

$os = $^O;
$appname = 'youtube-viewer';
$version = 'v2.4.9';
$mplayer_settings = '-prefer-ipv4 -cache 30000 -cache-min 5';
$MPlayer_srt_settings = '-unicode -utf8';
foreach $_ (@ARGV) {
    if ($_ =~ /^[-]+(sub|lang)=([\w]+)/) {
        $default_sub = "\L$2\E";
    }
}
unless ($default_sub) {
    $default_sub = 'en';
}
if ($os =~ /MSWin/) {
    $MPlayerLine = qq["C:\\Program Files\\SMPlayer\\mplayer\\mplayer.exe" $mplayer_settings];
} else {
    $MPlayerLine = "mplayer $mplayer_settings";
}
sub UserAgent {
    require LWP::UserAgent;
    $lwp = 'LWP::UserAgent'->new;
    $lwp->agent('Mozilla/5.0 (X11; U; Linux i686; en-US) Chrome/10.0.648.45');
    $lwp->env_proxy;
    $lwp->timeout(10);
    $lwp_is_set = 1;
}
unless ($os =~ /MSWin/) {
    $bred = "\e[1;31m";
    $bgreen = "\e[1;32m";
    $reset = "\e[0m";
}
$a = $ARGV[0];
$b = $ARGV[1];
unless ($b) {
    $b = '';
}
unless ($a) {
    $a = '';
}
my($Picks, $pickcat);
$catnr = '';
$Search = '';
$PickBackup = '';
$SearchBackup = '';
$MoreResults = '';
$FirstPage = 1;
$NextPage = 1;
$username = 0;
$pick = '';
$app = $0;
$app =~ s[(.*)/([^/]+)$][$2];
unless ($all_set) {
    foreach $arg (@ARGV) {
        if ($arg =~ /^-/) {
            if ($arg =~ /^[-]+(d|download)$/) {
                $Download_video = 1;
            }
            $SearchBackup .= " $arg ";
        } else {
            $Search .= "$arg ";
        }
    }
    $all_set = 1;
}
$all_args = join('', @ARGV);
foreach $arg (@ARGV) {
    next unless $arg =~ /^-/;
    $arg =~ s/--no[-]?video/-n/;
    $arg =~ s/--categories/-c/;
    $arg =~ s/^[-]+f(.*)/-f/;
    if ($arg eq '-n') {
        $MPlayerLine =~ s/mplayer /mplayer -novideo /;
        $MPlayerLine =~ s/mplayer.exe"/mplayer.exe" -novideo/;
        $SearchBackup .= ' --480';
    }
    if ($arg eq '-c') {
        $categories = 'TRUE';
    }
    if ($arg eq '-m' or $arg eq '-p') {
        $MoreResults = 1;
    } else {
        $MoreResults = 0;
    }
    if ($arg eq '-f') {
        $MPlayerLine =~ s/mplayer /mplayer -fs /;
        $MPlayerLine =~ s/mplayer.exe"/mplayer.exe" -fs/;
    }
    if ($categories and $arg =~ /^([\d]+)$/) {
        $catnr = $1;
    }
}
foreach $arg (@ARGV) {
    if ($arg eq '-c') {
        &Categories_area;
    }
    if ($arg eq '-u') {
        &Videos_from_username;
    }
    if ($arg =~ /^[-]+(h|help|\?)$/) {
        &help;
    }
    if ($arg =~ /^[-]+(v|version)$/) {
        &version;
    }
}
if (not $a or $a =~ /^[-]+/ and not $b) {
    if (length $a ne 11) {
        &InsertURL;
    }
}
foreach $code (@ARGV) {
    if ($code =~ /^([\w-]{11})$/) {
        $code = $1;
        if ($code =~ /([\d]+)|([A-Z]+)|-/) {
            $dont_exit = 1;
            $title = '';
            if (length $code eq 11) {
                &GetYouTube;
            } else {
                next;
            }
        }
    } elsif ($code =~ m[(v|embed)[=/]+([\w-]{11})]) {
        $code = $2;
        $dont_exit = 1;
        $title = '';
        if (length $code eq 11) {
            &GetYouTube;
        } else {
            next;
        }
    } elsif ($code =~ m[^http://] and not $code =~ /youtube\.com/) {
        &code_from_content($code);
    } else {
        next;
    }
}
sub help {
    $appname =~ s/(.+)/\U$1\E/g;
    die "
\t" . '=' x 17 . " $appname " . '=' x 17 . qq[
\t\t\t\t  by Trizen (trizen.go.ro)

 Usage: youtube-viewer [<url> | <video_id>] [-(4|7|1)] 
                       [-u <username>] [-c] [<keywords>] [-(f|n|m|p)] 

Base Options: youtube-viewer [...]
   <url>                : play an YouTube video by URL
   <code>               : play an YouTube video by code
   <keywords>           : search and play YouTube videos
  
Other options:
   -c, --categories     : shows available YouTube categories
   -n, --novideo        : plays only audio track of the video
   -d, --download       : downloads youtube video(s) with wget
   <keywords> -f        : plays all videos in fullscreen mode
   <keywords> -p        : plays all video results in order
   <keywords> -n        : plays only the audio track of video results
   <keywords> -m        : shows more video results (50 clips)
   <keywords> -(4|7)    : plays video results at 480p resolution (or 720p)
   <username> -u        : lists videos from a YouTube user profile
   -sub=<LANG>          : subtitle language (default: en) (depends on gcap)
   -v, --version        : prints version and exit
   -h, --help           : prints help and exit
 
Tips and tricks:
  1. Search and play all video results by adding "-p" after keywords.
  2. After search results, you can insert: 3 5 8 1 to play videos in your order
  3. Play all audio tracks of video results by adding "-p -n" after keywords.
  4. To listen music from YouTube use: "-c -n 3" and insert "all"
  5. Play all video results in fullscreen mode at 720p: "<keywords> -p -f -7"
  6. Play all videos from a user at 480p: "<username> -u -4" and insert "all"
  7. After search results, press <ENTER> for the next page

];
}
sub version {
    $appname =~ s/-/ /;
    $appname =~ s/(.)(.+) (.)/\U$1\E\L$2 \E\U$3\E/g;
    print "$appname $version\n";
    exit;
}
sub code_from_content {
    $url = shift @_;
    unless ($lwp_is_set) {
        &UserAgent;
    }
    $connect = $lwp->get($url);
    if ($connect->content =~ m[youtube\.com/(v|embed)/([\w-]{11})]) {
        $code = $2;
        if (length $code eq 11) {
            &GetYouTube;
        } else {
            next;
        }
    }
}
sub InsertURL {
    print "
$bred=>>$reset$bgreen Insert an YouTube URL or search something...
$reset> ";
    chomp($youtube = <STDIN>);
    if ($youtube =~ m[(v|embed)[=/]+([\w-]{11})]) {
        $code = $2;
        &GetYouTube;
    } elsif ($youtube =~ m[^http://] and not $youtube =~ /youtube\.com/) {
        &code_from_content($youtube);
    } elsif ($youtube) {
        $SearchBackup .= ' ' . $youtube;
        $Search = $youtube;
        $number = 0;
        &Trizen;
    } else {
        print $bred;
        print "\n(x_x) Unable to continue...\n\n";
        print $reset;
        exit;
    }
}
sub Videos_from_username {
    if ($a =~ /^[-]+u/ and not $b) {
        die "\nUsage:  $0 -u [username]\n\t$0 [username] -u\n\n";
    }
    if ($a =~ /^[-]+u/ and $b or $b =~ /^[-]+u/) {
        if ($b =~ /^[-]+u/) {
            $user = $a;
        } else {
            $user = $b;
        }
        $username = 1;
        $yt_api_url = "http://gdata.youtube.com/feeds/api/users/$user/uploads";
        &YoutubeAPI;
    }
}
sub Categories_area {
    if ($b =~ /[-]+[\d]+/) {
        $PickBackup = $b;
    }
    $NextPage = 0;
    unless ($lwp_is_set) {
        &UserAgent;
    }
    $connect = $lwp->get('http://gdata.youtube.com/schemas/2007/categories.cat');
    $content = $connect->content;
    $content =~ s/category term=/\ncategory_name=/g;
    @cates = split(?\n?, $content, 0);
    $n = 0;
    print "\n";
    foreach $cat (@cates) {
        if ($cat =~ /category_name='([^']+)' label='([^']+)'/ and not $cat =~ /deprecated/) {
            ++$n;
            $cat_name = $1;
            $cat_label = $2;
            $cat_label = decode_entities($cat_label);
            if ($n < 10) {
                print ' ';
            }
            print "$bred$n$reset - $cat_label\n";
            push @categories, "$n - $cat_name";
        }
    }
    if (not $catnr) {
        print $bgreen;
        print "\n=>> Insert a category number\n> ";
        print $reset;
        chomp($pickcat = <STDIN>);
    } else {
        $pickcat = $catnr;
    }
    foreach $cat (@categories) {
        if ($cat =~ /^$pickcat - (.+)/) {
            $yt_api_url = "http://gdata.youtube.com/feeds/api/standardfeeds/recently_featured_$1";
            &YoutubeAPI;
        }
    }
}
sub MPlayer {
    $youtube = '';
    if ($Download_video) {
        $title =~ s[/][|]g;
        $title = quotemeta $title;
        system qq[wget "$streaming" -O $title.mp4];
    } else {
        `$MPlayerLine "$streaming"`;
    }
    print "\n";
    if ($Picks) {
        if ($Picks eq 1) {
            &ForeachPick;
        }
    }
    if ($Search =~ m[[=/]+([\w\-]{11})] and not $dont_exit) {
        exit;
    }
    if ($Search or $a =~ /^[-]+c/ or $username eq 1) {
        unless ($dont_exit) {
            $category = '';
            $rating = '';
            $date = '';
            &PrintResults;
        }
    }
    unless ($dont_exit) {
        exit;
    }
}
sub YoutubeAPI {
    splice @Videos;
    $youtube_via_api = 1;
    if ($MoreResults) {
        $results = 50;
    } else {
        $results = 20;
    }
    $start_index = 1;
    if (not $yt_api_url =~ /\?/) {
        $yt_api_url .= "?start-index=$start_index&max-results=$results";
    } else {
        $yt_api_url .= "&start-index=$start_index&max-results=$results";
    }
    unless ($lwp_is_set) {
        &UserAgent;
    }
    $cc = $lwp->get($yt_api_url)->content;
    if ($cc eq 'User not found') {
        die "\n(x_x) $cc...\n\n";
    }
    &Parse;
    &PrintResults;
    $youtube_via_api = 0;
}
unless ($dont_exit) {
    &Trizen;
}
sub Trizen {
    $PageNumber = 1;
    $FirstPage = 1;
    $Search =~ s/^\s|\s$//g;
    $Search = uri_escape($Search);
    if ($MoreResults) {
        $results = 50;
    } else {
        $results = 20;
    }
    $ys = "http://gdata.youtube.com/feeds/api/videos?q=$Search&max-results=$results";
    $start_index = 1;
    $ys .= "&start-index=$start_index";
    unless ($lwp_is_set) {
        &UserAgent;
    }
    $connect = $lwp->get($ys);
    @content = split(?\n?, $connect->content, 0);
    &Search;
}
sub Parse {
    $cc =~ s/\n//g;
    $cc =~ s/<title type='text'>/\nTITLE=/g;
    @content = split(?\n?, $cc, 0);
    sub Search {
        splice @Videos;
        $cc = join('', @content);
        &Parse;
        &PrintResults;
    }
    foreach $_ (@content) {
        next unless $_ =~ /^TITLE=/;
        if ($_ =~ m[</media\:description>]) {
            $_ =~ s[TITLE=([^\<]+)</title>(.+)v=([\w\-]{11})(.+)duration([^']*)'([\d\:]+)'(.+)<media:description type='plain'>([^<]*)(.*)viewCount='([\d]*)'(.*)][v=$3+title=$1>+video-time">$6>views=$10>description=$8];
        } else {
            $_ =~ s[TITLE=([^\<]+)</title>(.+)v=([\w\-]{11})(.+)duration([^']*)'([\d\:]+)'(.*)viewCount='([\d]*)'(.*)][v=$3+title=$1>+video-time">$6>views=$8>description=No description available...];
        }
        push @Videos, $_;
    }
}
sub PrintResults {
    splice @codes;
    $number = 0;
    print "\n";
    foreach $_ (@Videos) {
        chomp($line = $_);
        if ($line =~ /v=([\w\-]{11})(.*)title=([^>]+)>\+(.*)-time">([\d\:]*)>views=([\d]*)>description=(.*)/) {
            ++$number;
            $title = $3;
            $code = $1;
            $views = $6;
            $desc = $7;
            $time = $5;
            unless ($time =~ /\:/) {
                $sec = $time;
                $time = $sec / 3600 % 24 . ':' . $sec / 60 % 60 . ':' . $sec % 60;
                $time =~ s/^0\://;
                unless ($time =~ /\:/) {
                    $time = "0:$time";
                }
                if ($time =~ /(.):(.):(.+)/) {
                    $time = "$1:0$2:$3";
                }
                if ($time =~ /^(.+):(.)$/) {
                    $time = "$1:0$2";
                }
            }
            $title = uri_unescape($title);
            $title = decode_entities($title);
            push @codes, "$number # title=$title # time=$time # code=$code # views=$views # desc=$desc";
            print "$bred";
            if ($number < 10) {
                print ' ';
            }
            print "$number$reset - $title ($time)\n$bred";
        }
    }
    if ($SearchBackup) {
        if ($SearchBackup =~ / -p/) {
            for ($i = 1; $i <= $number; ++$i) {
                push @picks2, "$i ";
            }
            $SearchBackup =~ s/ -p//g;
            $youtube = join('', @picks2);
            @picks = split(' ', $youtube, 0);
            &PicksArea;
        }
    }
    print "
$bred=>>$reset$bgreen Insert a number or search something else
$reset> ";
    chomp($youtube = <STDIN>);
    $PickBackup = $youtube;
    $SearchBackup .= ' ' . $youtube;
    if ($youtube =~ /^(q|quit|exit)$/) {
        exit;
    }
    if ($PickBackup =~ m[^http://] and not $PickBackup =~ /youtube\.com/) {
        &code_from_content($PickBackup);
    }
    if ($PickBackup =~ /([\d]+) [-]+([\d]+)/) {
        $youtube = $1;
    }
    if ($youtube =~ /^([\d]+)$/) {
        if ($youtube > $number or $youtube eq 0) {
            print "\n";
            &PrintResults;
        } else {
            $PICK = $1;
            &ForeachCode;
        }
    } elsif (not $youtube) {
        $PageNumber = $FirstPage;
        ++$PageNumber;
        if ($ys) {
            if ($ys =~ /index=([\d]+)/) {
                $old_index = $1;
                $start_index = $old_index + $results;
                $ys =~ s/index=$old_index/index=$start_index/;
                $connect = $lwp->get($ys);
                splice @content;
                @content = split(/\n/, $connect->content, 0);
                print "\n";
                &Search;
            }
        } elsif ($yt_api_url) {
            $youtube_via_api = 1;
            splice @Videos;
            $ys = '';
            $youtube_via_api = 1;
            if ($yt_api_url =~ /index=([\d]+)/) {
                $old_index = $1;
                $start_index = $old_index + $results;
                $yt_api_url =~ s/index=$old_index/index=$start_index/;
                $cc = $lwp->get($yt_api_url)->content;
                &Parse;
                &PrintResults;
                $youtube_via_api = 0;
            }
        }
    } elsif ($youtube eq 'all') {
        $SearchBackup .= ' --1080';
        splice @picks;
        for ($i = 1; $i <= $number; ++$i) {
            push @picks, "$i";
        }
        &PicksArea;
    } elsif ($youtube =~ m[v([=/]+)([\w\-]{11})]) {
        $code = $2;
        $desc = '';
        $title = '';
        $duration = '';
        $views = '';
        &GetYouTube;
    } elsif ($youtube =~ /[\d]+ [\d]+/) {
        @picks = split(' ', $youtube, 0);
        &PicksArea;
    } elsif ($youtube) {
        $Search = $youtube;
        &Trizen;
    }
}
sub PicksArea {
    if (@picks) {
        $NrOfPicks = @picks;
    }
    $no = 0;
    $lastpick = '';
    $number = 0;
    &ForeachPick;
}
sub ForeachPick {
    for ($number = $no; $number <= $NrOfPicks; ++$number) {
        $no = $number;
        $pick = $picks[$number];
        if ($pick) {
            next if $lastpick eq $pick;
        }
        &PrintResults if $number eq $NrOfPicks;
        $Picks = 1;
        $lastpick = $pick;
        &PlayBack;
    }
}
sub ForeachCode {
    foreach $line (@codes) {
        if ($line =~ /^$PICK # title=(.*) # time=(.*) # code=([\w\-]{11}) # views=([\d]*) # desc=(.*)/) {
            $title = $1;
            $duration = $2;
            $views = $4;
            $code = $3;
            $desc = $5;
            &GetYouTube;
        }
    }
}
sub PlayBack {
    foreach $line (@codes) {
        if ($Picks eq 1 and not $line =~ /^$pick #/) {
            next;
        } elsif ($line =~ /^$pick # title=(.*) # time=(.*) # code=([\w-]{11}) # views=([\d]*) # desc=(.*)/) {
            $title = $1;
            $duration = $2;
            $views = $4;
            $code = $3;
            $desc = $5;
            &GetYouTube;
        }
    }
}
sub VideoCheck {
    $streaming =~ s/^[\w]*%[\w]*http:/http:/;
    if (not $streaming =~ /itag=34/ and $streaming =~ /itag=([\d]+)[\W]+/) {
        $itag = $1;
        $streaming =~ s/(.*)http(.+)itag=$itag([^\%]*)(.+)/http$2itag=$itag$3/;
        $streaming =~ s/%(.*)$//;
        unless ($SearchBackup =~ / [-]+f/) {
            $MPlayerLine =~ s/-fs //;
        }
        &Description;
        &MPlayer;
    } elsif ($SearchBackup =~ / [-]+4/) {
        $streaming =~ s/(.*)http(.+)itag=34([^\%]*)(.+)/http$2itag=34$3/;
        unless ($SearchBackup =~ / [-]+f/) {
            $MPlayerLine =~ s/-fs //;
        }
        &Description;
        &MPlayer;
    } elsif ($SearchBackup =~ / [-]+7/) {
        if ($streaming =~ /itag=22/) {
            $streaming =~ s/(.*)http(.+)itag=22([^\%]*)(.+)/http$2itag=22$3/;
            &Fullscreen_check;
            &Description;
            &MPlayer;
        } else {
            unless ($SearchBackup =~ / [-]+f/) {
                $MPlayerLine =~ s/-fs //;
            }
            $streaming =~ s/(.*)http(.+)itag=34([^\%]*)(.+)/http$2itag=34$3/;
            &Description;
            &MPlayer;
        }
    } elsif ($SearchBackup =~ / [-]+1/) {
        if ($streaming =~ /itag=37/) {
            $streaming =~ s/(.*)http(.+)itag=37([^\%]*)(.+)/http$2itag=37$3/;
            &Fullscreen_check;
            &Description;
            &MPlayer;
        } elsif ($streaming =~ /itag=22/) {
            $streaming =~ s/(.*)http(.+)itag=22([^\%]*)(.+)/http$2itag=22$3/;
            &Fullscreen_check;
            &Description;
            &MPlayer;
        } else {
            unless ($SearchBackup =~ / [-]+f/) {
                $MPlayerLine =~ s/-fs //;
            }
            $streaming =~ s/(.*)http(.+)itag=34([^\%]*)(.+)/http$2itag=34$3/;
            &Description;
            &MPlayer;
        }
    }
    if (not $dont_exit && $all_args =~ / [-]+(1|7|4)/) {
        &Description;
        &ResolutionSearch;
    }
}
sub Description {
    if ($connect->content =~ /rating average=['"]+([\d\.]+)/) {
        $rating = $1;
        $rating =~ s/^([\d\.]{4}).*/$1/;
    } elsif ($connect->content =~ /avg_rating=([^&]+)/) {
        $rating = $1;
        $rating =~ s/^([\d\.]{4}).*/$1/;
    }
    unless ($title) {
        $feed_url = 'http://gdata.youtube.com/feeds/api/videos/' . $code;
        $connect = $lwp->get($feed_url);
        if ($connect->content =~ m[media:title type='plain'>([^<]+)</media:title>]) {
            $title = uri_unescape($1);
            $title = decode_entities($title);
        }
        if ($connect->content =~ /viewCount=['"]+([\d]+)/) {
            $views = $1;
        }
        if ($connect->content =~ m[<published>([\d-]+)(.*)</published>]) {
            chomp($date = $1);
            $date =~ s/-/./g;
            $date =~ s/(.+)\.(.+)\.(.+)/$3.$2.$1/;
        } else {
            $date = '';
        }
        if ($connect->content =~ m[<media:description type='plain'>([^<]+)</media]) {
            $desc = $1;
        }
        if ($connect->content =~ m[<author><name>([^<]+)</name>]) {
            $author = $1;
        }
        if ($connect->content =~ /category label=['"]+([^'"]+)/) {
            $category = decode_entities($1);
        }
    }
    if ($desc) {
        print "\n$bred=>> $reset";
        print $bgreen;
        print "$title\n";
        print $reset;
        print '-' x 80;
        $description = uri_unescape($desc);
        $description = decode_entities($description);
        print "\n$description\n";
        print '-' x 80 . "\n";
    } else {
        print "\n";
    }
    print "$bred=>> $reset";
    print $bgreen;
    print "View & Download\n";
    print $reset;
    print '-' x 80;
    $get = $streaming;
    $get =~ s/http:([^\%]+)(.*)/http:$1/;
    $get =~ s/(.*)http/http/;
    $get =~ s/\\//g;
    print "\n* URL $url\n";
    print "* GET $get\n";
    print '-' x 80 . "\n";
    $count = $title =~ s/(.)/$1/gs;
    if ($count <= 40) {
        print "$bred\t\t=>> ";
    } elsif ($count >= 40 and $count <= 55) {
        print "$bred\t=>> ";
    } elsif ($count >= 56) {
        print "$bred  =>> ";
    }
    print $bgreen;
    print "$title";
    print $reset;
    print "$bred <<=\n";
    print $reset;
    if ($connect->content =~ /\&author=([^&]+)/) {
        $author = $1;
    }
    if ($author) {
        print "\n* Author: $author\n";
    }
    if ($duration) {
        print "* Duration: $duration\n";
    }
    if ($category) {
        print "* Category: $category\n";
    }
    if ($rating) {
        print "* Rating: $rating\n";
    }
    if ($views) {
        $views = reverse($views);
        $views =~ s/([\d]{3})/$1./g;
        $views = reverse($views);
        $views =~ s/^\.//;
        print "* Views: $views\n";
    }
    if ($date) {
        print "* Published: $date\n";
    }
    print '-' x 80 . "\n\n";
}
sub Edit_srt_file {
    `perl -pi -e 's/&quot;/"/g' $srt_file`;
    `perl -pi -e "s/&#39;/'/g" $srt_file`;
}
sub MPlayerLine_with_srt {
    $MPlayerLine .= " $MPlayer_srt_settings -sub $srt_file";
}
sub GetYouTube {
    $youtube = "http://www.youtube.com/get_video_info?&video_id=$code" . 
    '&el=detailpage&ps=default&eurl=&gl=US&hl=en';
    unless ($lwp_is_set) {
        &UserAgent;
    }
    $connect = $lwp->get($youtube);
    $url = "http://www.youtube.com/watch?v=$code";
    $MPlayerLine =~ s/ $MPlayer_srt_settings -sub(.*)$//;
    if (-e '/usr/bin/gcap' and not $MPlayerLine =~ / -novideo/ 
    and $connect->content =~ /&has_cc=True&/ and not $Download_video) {
        chdir '/tmp/';
        print "\n";
        system "gcap $url";
        @ls = `ls`;
        $srt_file = '';
        foreach $line (@ls) {
            if ($line =~ /${code}_$default_sub\.srt/) {
                $srt_file = "${code}_$default_sub.srt";
                &Edit_srt_file;
                &MPlayerLine_with_srt;
            }
        }
        unless ($srt_file) {
            foreach $line (@ls) {
                if ($line =~ /$code([\w]*)\.srt/) {
                    $srt_file = "$code$1.srt";
                    &Edit_srt_file;
                    &MPlayerLine_with_srt;
                }
            }
        }
    }
    if ($connect->content =~ /fmt_url_map=([^\&]+)\&/) {
        $streaming = $1;
        $streaming =~ s/%3A/:/gi;
        $streaming =~ s[%2F][/]gi;
        $streaming =~ s/%26/&/g;
        $streaming =~ s/%3D/=/gi;
        $streaming =~ s/%3F/?/gi;
        $streaming =~ s/%252C/,/gi;
        &VideoCheck;
    } else {
        $unable = "$bred(x_x) Unable to stream: $reset$url\n";
        print $bred;
        print "\n(x_x) Something went wrong...\n\n";
        print $reset;
        unless ($SearchBackup =~ / -p/ and $NrOfPicks) {
            print "$unable\n";
        }
        if ($Search and not $dont_exit) {
            unless ($SearchBackup =~ / -p/) {
                sleep 1;
                &PrintResults;
            }
        } else {
            unless ($a =~ /^[-]+c/ or $username or $dont_exit) {
                exit;
            }
        }
    }
}
sub ResolutionSearch {
    if ($streaming =~ /itag=37/ and not $SearchBackup =~ / -p/) {
        &pick;
    } elsif ($SearchBackup =~ / -p/) {
        if ($streaming =~ /itag=37/) {
            $streaming =~ s/(.*)http(.+)itag=37([^\%]*)(.+)/http$2itag=37$3/;
            &Fullscreen_check;
            &Description;
            &MPlayer;
        }
    } elsif ($streaming =~ /itag=22/) {
        $streaming =~ s/(.*)http(.+)itag=22([^\%]*)(.+)/http$2itag=22$3/;
        &Fullscreen_check;
        &MPlayer;
    } else {
        $streaming =~ s/(.*)http(.+)itag=34([^\%]*)(.+)/http$2itag=34$3/;
        unless ($SearchBackup =~ / [-]+f/) {
            $MPlayerLine =~ s/-fs //;
        }
        &MPlayer;
    }
}
sub Fullscreen_check {
    $MPlayerLine =~ s/mplayer -p/mplayer -fs -p/;
    $MPlayerLine =~ s/mplayer.exe" -p/mplayer.exe" -fs -p/;
}
sub pick {
    print "$bred=>>$reset $bgreen Please choose quality of video (default: 1)";
    print "\n$reset";
    print "
  $bred 1$reset - 1280x720  (720p)
  $bred 2$reset - 1920x1080 (1080p)
  ";
    print '=' x 23 . "\n";
    print $bgreen;
    print "\n=>> Pick format: ";
    print $reset;
    chomp($pick = <STDIN>);
    print '-' x 80 . "\n\n";
    if ($pick eq 2) {
        $streaming =~ s/(.*)http(.+)itag=37([^\%]*)(.+)/http$2itag=37$3/;
        &Fullscreen_check;
        &MPlayer;
    } else {
        $streaming =~ s/(.*)http(.+)itag=22([^\%]*)(.+)/http$2itag=22$3/;
        &Fullscreen_check;
        &MPlayer;
    }
}
